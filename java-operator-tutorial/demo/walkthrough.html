<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Demo Walkthrough :: Java Operator Tutorial</title>
    <link rel="canonical" href="https://hatmarch.github.io/java-operator-sdk-tutorial/java-operator-tutorial/demo/walkthrough.html">
    <link rel="prev" href="setup.html">
    <link rel="next" href="../01-setup.html">
    <meta name="generator" content="Antora 2.3.4">
    <link rel="stylesheet" href="../../_/css/site.css">
<link rel="icon" href="../../_/img/favicon.ico" type="image/x-icon">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://developers.redhat.com" target="_blank"><img
          src="../../_/img/header_logo.png" height="40px" alt="Red Hat Developer Program"></a>
      <a class="navbar-item" href="https://hatmarch.github.io/java-operator-sdk-tutorial">Java Operator Tutorial</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="#">Books</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">CheatSheets</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">CheatSheet A</a>
            <a class="navbar-item" href="#">CheatSheet B</a>
            <a class="navbar-item" href="#">CheatSheet C</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Upcoming Events</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Event A</a>
            <a class="navbar-item" href="#">Event B</a>
            <a class="navbar-item" href="#">Event C</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">More Tutorials</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Tutorial A</a>
            <a class="navbar-item" href="#">Tutorial B</a>
            <a class="navbar-item" href="#">Tutorial C</a>
          </div>
        </div>
        <div class="navbar-item">
          <span class="control">
            <a class="button is-primary" href="#">Download</a>
          </span>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="java-operator-tutorial" data-version="master">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="../index.html">Java and Quarkus Operator Tutorial</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="index.html">Quarkus Operator Demo</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="setup.html">Demo Setup</a>
  </li>
  <li class="nav-item is-current-page" data-depth="2">
    <a class="nav-link" href="walkthrough.html">Demo Walkthrough</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../01-setup.html">Tutorial (Placeholder)</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Java and Quarkus Operator Tutorial</span>
    <span class="version">master</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <span class="title">Java and Quarkus Operator Tutorial</span>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="../index.html">master</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../index.html">Java and Quarkus Operator Tutorial</a></li>
    <li><a href="index.html">Quarkus Operator Demo</a></li>
    <li><a href="walkthrough.html">Demo Walkthrough</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="file:///workspaces/java-operator-sdk-tutorial/documentation/modules/demo/pages/walkthrough.adoc">Edit this Page</a></div>
</div>
  <div class="content">
<article class="doc">
<h1 class="page">Demo Walkthrough</h1>
<div class="sect1">
<h2 id="_prereqs"><a class="anchor" href="#_prereqs"></a>Prereqs</h2>
<div class="sectionbody">
<div class="paragraph">
<p>See <a href="setup.html" class="page">setup</a>.  Before attempting the walkthrough you should run this script:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">${DEMO_HOME}/scripts/prepare-demo.sh</code></pre>
</div>
</div>
<div class="paragraph">
<p>If the script ran successfully, you should see the following output:</p>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">NAME            STATUS   AGE
operator-test   Active   55s
namespace "operator-test" deleted
customresourcedefinition.apiextensions.k8s.io "appops.org.mhildenb.operatortutorial" deleted
namespace/operator-test created
Context "minikube" modified.
customresourcedefinition.apiextensions.k8s.io/appops.org.mhildenb.operatortutorial created
deployment.apps/demo-app created
Waiting for deployment "demo-app" rollout to finish: 0 of 1 updated replicas are available...
deployment "demo-app" successfully rolled out
demo-app successfully deployed
namespace/demo-operator unchanged
serviceaccount/demo-operator created
clusterrolebinding.rbac.authorization.k8s.io/operator-admin configured
deployment.apps/demo-operator created
Waiting for deployment "demo-operator" rollout to finish: 0 of 1 updated replicas are available...
deployment "demo-operator" successfully rolled out
demo-operator successfully deployed</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_terminal_setup"><a class="anchor" href="#_terminal_setup"></a>Terminal Setup</h2>
<div class="sectionbody">
<div class="paragraph">
<p>For this demo VSCode is assumed.  Make sure you have 4 terminals all with a kubernetes context pointing to the namespace <code>operator-test</code>.  Click the tabs below to see information about each terminal and any initial commands that need to be run</p>
</div>
<div class="tabset is-loading">
<div class="ulist tabs">
<ul>
<li>
<p><a id="tabset1_terminal-1"></a>Terminal 1</p>
</li>
<li>
<p><a id="tabset1_terminal-2"></a>Terminal 2</p>
</li>
<li>
<p><a id="tabset1_terminal-3"></a>Terminal 3</p>
</li>
<li>
<p><a id="tabset1_terminal-4"></a>Terminal 4</p>
</li>
</ul>
</div>
<div class="content">
<div class="tab-pane" aria-labelledby="tabset1_terminal-1">
<div class="paragraph">
<p>Terminal one will be used for running local build commands and will be particularly important if showing a locally running build</p>
</div>
</div>
<div class="tab-pane" aria-labelledby="tabset1_terminal-2">
<div class="paragraph">
<p>Terminal 2 will be our CR watch window.  This is where we&#8217;ll see updates to our CustomResource.</p>
</div>
<div class="paragraph">
<p>Run the following command to get it started:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash"># watch updates every second with this command
watch -t -d -n 1 -x -- kubectl patch appops/my-bespoke-app -o yaml --type='json' -p='[{"op": "remove", "path": "/metadata/managedFields" }, {"op": "remove", "path": "/metadata/annotations" } ]' --dry-run=client</code></pre>
</div>
</div>
</div>
<div class="tab-pane" aria-labelledby="tabset1_terminal-3">
<div class="paragraph">
<p>The third terminal should be running the logs of the application (which will initially be more verbose than specified in the <code>AppOps</code> custom resource.</p>
</div>
<div class="paragraph">
<p>Run the following command to get this terminal ready:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash"># start logging the demo app
stern demo-app --since=1s -n operator-test</code></pre>
</div>
</div>
</div>
<div class="tab-pane" aria-labelledby="tabset1_terminal-4">
<div class="paragraph">
<p>The fourth terminal is used for issuing k8 commands</p>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>When you&#8217;ve finished, your terminals should look something like this (though the content will not be the same at this point)</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/cr-terminals.png" alt="cr terminals">
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="demo1"><a class="anchor" href="#demo1"></a>Demo 1: Intro to the application</h2>
<div class="sectionbody">
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Make a call to the hello endpoint</p>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">curl ${DEMO_OPERATOR_POD_URI_OVERRIDE}/hello</code></pre>
</div>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">hello%</code></pre>
</div>
</div>
</li>
<li>
<p>Next show terminal 3&#8217;s logs and how its logging at a <code>INFO</code> level</p>
</li>
<li>
<p>Show our app&#8217;s AppOps in vscode by opening <code>appops-crd.yaml</code> quickly</p>
</li>
<li>
<p>In the 4th terminal, show that the demo operator is running</p>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl get deploy/demo-operator</code></pre>
</div>
</div>
<div class="listingblock console-output">
<div class="content">
<pre>NAME            READY   UP-TO-DATE   AVAILABLE   AGE
demo-operator   1/1     1            1           8m</pre>
</div>
</div>
</li>
<li>
<p>Explain that the watch window, terminal 2 is watching the CR we&#8217;re about to create</p>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl apply -f ${DEMO_HOME}/demo/kube/myapp-cr.yaml</code></pre>
</div>
</div>
</li>
<li>
<p>Once the CR is applied, you should see the watch window change and the logging get less verbose</p>
<div class="imageblock">
<div class="content">
<img src="_images/cr-terminals.png" alt="cr terminals">
</div>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect1">
<h2 id="demo2"><a class="anchor" href="#demo2"></a>Demo 2: Show Operator Responding to Site Load</h2>
<div class="sectionbody">
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Run the following command to increase load threshold</p>
<div class="tabset is-loading">
<div class="ulist tabs">
<ul>
<li>
<p><a id="tabset2_terminal-4"></a>Terminal 4</p>
</li>
</ul>
</div>
<div class="content">
<div class="tab-pane" aria-labelledby="tabset2_terminal-4">
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">hey -n 30 -c 30 -q 1 ${DEMO_OPERATOR_POD_URI_OVERRIDE}/hello</code></pre>
</div>
</div>
</div>
</div>
</div>
</li>
<li>
<p>You should then see the information in the CR change as well as the app&#8217;s logging get more verbose:</p>
<div class="imageblock">
<div class="content">
<img src="_images/cr-load.png" alt="cr load">
</div>
</div>
</li>
</ol>
</div>
<div class="sect2">
<h3 id="_other_things_to_try"><a class="anchor" href="#_other_things_to_try"></a>Other things to try</h3>
<div class="sect3">
<h4 id="_edit_the_custom_resource_directly"><a class="anchor" href="#_edit_the_custom_resource_directly"></a>Edit the Custom Resource directly</h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Edit the Custom Resource directly</p>
<div class="tabset is-loading">
<div class="ulist tabs">
<ul>
<li>
<p><a id="tabset3_terminal-4"></a>Terminal 4</p>
</li>
</ul>
</div>
<div class="content">
<div class="tab-pane" aria-labelledby="tabset3_terminal-4">
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl edit appops</code></pre>
</div>
</div>
</div>
</div>
</div>
</li>
<li>
<p>Change something like the <code>defaultLogThreshold</code> and save the edit</p>
</li>
<li>
<p>Notice that the watch in <strong>Terminal 2</strong> updates and the logs of the pod in <strong>Terminal 3</strong> has changed accordingly</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_increase_the_number_of_pods"><a class="anchor" href="#_increase_the_number_of_pods"></a>Increase the number of pods</h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Run the following command to increase the number of pods</p>
<div class="tabset is-loading">
<div class="ulist tabs">
<ul>
<li>
<p><a id="tabset4_terminal-4"></a>Terminal 4</p>
</li>
</ul>
</div>
<div class="content">
<div class="tab-pane" aria-labelledby="tabset4_terminal-4">
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl patch deploy/demo-app --type='json' -p='[{"op": "replace", "path": "/spec/replicas", "value": 2 }]'</code></pre>
</div>
</div>
</div>
</div>
</div>
</li>
<li>
<p>Notice how the custom resource changes in <strong>Terminal 2</strong> as it should now show multiple pods</p>
</li>
</ol>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="demo3"><a class="anchor" href="#demo3"></a>Demo 3: Run the operator in the debugger to show how it works</h2>
<div class="sectionbody">
<div class="paragraph">
<p>To run this demo you will need to run some setup first</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>First setup your environment accordingly</p>
<div class="tabset is-loading">
<div class="ulist tabs">
<ul>
<li>
<p><a id="tabset5_terminal-1"></a>Terminal 1</p>
</li>
</ul>
</div>
<div class="content">
<div class="tab-pane" aria-labelledby="tabset5_terminal-1">
<div class="paragraph">
<p>Make sure the following environment variables are set:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>DEMO_OPERATOR_POD_URI_OVERRIDE=http://192.168.86.87:8008</code></p>
</li>
<li>
<p><code>LOG_MODULE_TEST_INTEGRATION_URI=http://192.168.86.87:8008</code></p>
</li>
<li>
<p><code>USER=&lt;your quay.io user&gt;</code></p>
</li>
<li>
<p><code>PASSWORD=&lt;your quay.io password&gt;</code></p>
</li>
</ul>
</div>
</div>
</div>
</div>
</li>
<li>
<p>Remove the operator from the cluster</p>
<div class="tabset is-loading">
<div class="ulist tabs">
<ul>
<li>
<p><a id="tabset6_terminal-4"></a>Terminal 4</p>
</li>
</ul>
</div>
<div class="content">
<div class="tab-pane" aria-labelledby="tabset6_terminal-4">
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl delete deploy/demo-operator</code></pre>
</div>
</div>
</div>
</div>
</div>
</li>
<li>
<p>Run the following to start the app running locally</p>
<div class="tabset is-loading">
<div class="ulist tabs">
<ul>
<li>
<p><a id="tabset7_terminal-1"></a>Terminal 1</p>
</li>
</ul>
</div>
<div class="content">
<div class="tab-pane" aria-labelledby="tabset7_terminal-1">
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">cd ${DEMO_HOME}/demo/demo-operator
mvn quarkus:dev -Dsuspend</code></pre>
</div>
</div>
</div>
</div>
</div>
</li>
<li>
<p>the <code>-Dsuspend</code> means that the operator will not move on until you connect the debugger</p>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Before demonstrating in the debugger make sure:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Number of pods is set to 0</p>
</li>
<li>
<p><code>DEMO_OPERATOR_POD_URI_OVERRIDE=http://192.168.86.87:8008</code></p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
</li>
</ol>
</div>
</div>
</div>
<nav class="pagination">
  <span class="prev"><a href="setup.html" class="query-params-link">Demo Setup</a></span>
  <span class="next"><a href="../01-setup.html" class="query-params-link">Tutorial (Placeholder)</a></span>
</nav>
</article>
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
  </div>
</main>
</div>
<footer class="footer">
  <a class="rhd-logo" href="https://developers.redhat.com" target="_blank"></div>
</footer>
<script src="../../_/js/vendor/clipboard.js"></script>
<script src="../../_/js/site.js"></script>
<script async src="../../_/js/vendor/highlight.js"></script>
  </body>
</html>
